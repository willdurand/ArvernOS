version: 2.1

references:
  defaults: &defaults
    docker:
      - image: willdurand/arvernos-circle:latest

commands:
  setup:
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: create config for Circle CI
          command: |
            cp .circleci/config config

  build:
    parameters:
      target:
        type: string
      arch:
        type: string
    steps:
      - setup
      - run: ARCH=<<parameters.arch>> make clean << parameters.target >>
      - run:
          name: ensure the kernel has been built
          command: test -f build/<< parameters.arch >>/dist/kernel-<< parameters.arch >>.bin

  run_qemu:
    parameters:
      title:
        type: string
      command:
        type: string
    steps:
      - run:
          name: << parameters.title >>
          command: << parameters.command >>
          no_output_timeout: 2m
          environment:
            TERM: xterm-256color

jobs:
  build-aarch64:
    <<: *defaults
    parameters:
      target:
        type: string
    steps:
      - build:
          arch: aarch64
          target: << parameters.target >>
      - run:
          name: build checks
          command: |
            test -f build/aarch64/dist/ArvernOS-aarch64.img
            test -f build/aarch64/dist/kernel-aarch64.bin

  build-x86_64:
    <<: *defaults
    parameters:
      target:
        type: string
    steps:
      - build:
          arch: x86_64
          target: << parameters.target >>
      - run:
          name: build checks
          command: |
            test -f build/x86_64/dist/ArvernOS-x86_64.iso
            test -f build/x86_64/dist/libc-ArvernOS-x86_64.a
            test -f build/x86_64/misc/initrd.tar
            test -f build/x86_64/misc/isofiles/boot/grub/grub.cfg
            test -f build/x86_64/misc/isofiles/boot/kernel-x86_64.bin

  checks:
    <<: *defaults
    steps:
      - setup
      - run:
          name: fmt
          command: |
            make fmt
            git diff --exit-code || (echo "\n\nPlease run 'make fmt' to format the code and fix the problem(s) above"; false)

  unit-tests:
    <<: *defaults
    steps:
      - setup
      - run:
          name: unit tests
          command: make clean test

  kernel-selftest-with-ubsan:
    <<: *defaults
    parameters:
      ubsan:
        type: integer
    steps:
      - setup
      - run_qemu:
          title: kernel selftest
          command: make clean run-test GRUB_KERNEL_CMDLINE='kshell selftest' UBSAN=<< parameters.ubsan >>

  kernel-selftest-10-times:
    <<: *defaults
    steps:
      - setup
      - run_qemu:
          title: kernel selftest ran 10 times
          command: |
            make clean run-test GRUB_KERNEL_CMDLINE="$(echo "kshell$(printf ' selftest%.0s' {1..10})")"

  userland-test-suite-with-ubsan:
    <<: *defaults
    parameters:
      ubsan:
        type: integer
    steps:
      - setup
      - run_qemu:
          title: userland test suite
          command: make clean run-test UBSAN=<< parameters.ubsan >>

workflows:
  default-workflow:
    jobs:
      - build-aarch64:
          matrix:
            parameters:
              target: [debug, release]
      - build-x86_64:
          matrix:
            parameters:
              target: [debug, release]
      - checks
      - kernel-selftest-with-ubsan:
          matrix:
            parameters:
              ubsan: [0, 1]
      - kernel-selftest-10-times
      - unit-tests
      - userland-test-suite-with-ubsan:
          matrix:
            parameters:
              ubsan: [0, 1]

version: 2.1

references:
  defaults: &defaults
    docker:
      - image: willdurand/willos-circle:latest

commands:
  setup:
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: create willosconfig for Circle CI
          command: |
            cp .circleci/willosconfig willosconfig

  run_qemu:
    parameters:
      title:
        type: string
      command:
        type: string
    steps:
      - run: echo 'export TERM=xterm' >> $BASH_ENV
      - run:
          name: << parameters.title >>
          command: << parameters.command >>
          no_output_timeout: 2m

jobs:
  build-debug:
    <<: *defaults
    steps:
      - setup
      - run:
          name: build (debug)
          command: |
            make clean debug
            test -f build/x86_64/isofiles/boot/grub/grub.cfg
            test -f build/x86_64/isofiles/boot/initrd.tar
            test -f build/x86_64/dist/kernel-x86_64.bin
            test -f build/x86_64/dist/libc-willOS-x86_64.a
            test -f build/x86_64/dist/willOS-x86_64.iso

  build-release:
    <<: *defaults
    steps:
      - setup
      - run:
          name: build (release)
          command: |
            make clean release
            test -f build/x86_64/isofiles/boot/grub/grub.cfg
            test -f build/x86_64/isofiles/boot/initrd.tar
            test -f build/x86_64/dist/kernel-x86_64.bin
            test -f build/x86_64/dist/libc-willOS-x86_64.a
            test -f build/x86_64/dist/willOS-x86_64.iso

  unit-tests:
    <<: *defaults
    steps:
      - setup
      - run:
          name: unit tests
          command: make clean test

  checks:
    <<: *defaults
    steps:
      - setup
      - run:
          name: fmt
          command: |
            make fmt
            git diff --exit-code || (echo "\n\nPlease run 'make fmt' to format the code and fix the problem(s) above"; false)

  userland-test-suite:
    <<: *defaults
    steps:
      - setup
      - run_qemu:
          title: userland test suite
          command: make clean run-test

  userland-test-suite-ubsan:
    <<: *defaults
    steps:
      - setup
      - run_qemu:
          title: userland test suite with UBSan enabled
          command: make clean run-test UBSAN=1

  kernel-selftest:
    <<: *defaults
    steps:
      - setup
      - run_qemu:
          title: kernel selftest
          command: make clean run-test GRUB_KERNEL_CMDLINE='kshell selftest'

  kernel-selftest-10-times:
    <<: *defaults
    steps:
      - setup
      - run_qemu:
          title: kernel selftest ran 10 times
          command: |
            make clean run-test GRUB_KERNEL_CMDLINE="$(echo "kshell$(printf ' selftest%.0s' {1..10})")"

workflows:
  default-workflow:
    jobs:
      - build-debug
      - build-release
      - unit-tests
      - userland-test-suite
      - userland-test-suite-ubsan
      - kernel-selftest
      - kernel-selftest-10-times

version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:2021.10
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: install dependencies
          command: |
            # Copy this file to /tmp to let `Makefile` know that we are running
            # in a Docker-ish configuration.
            cp tools/install-linux-deps /tmp/
            sudo /tmp/install-linux-deps
      - run:
          name: build (debug)
          command: |
            make clean debug
            test -f build/x86_64/isofiles/boot/grub/grub.cfg
            test -f build/x86_64/isofiles/boot/initrd.tar
            test -f build/x86_64/dist/kernel-x86_64.bin
            test -f build/x86_64/dist/libc-willOS-x86_64.a
            test -f build/x86_64/dist/willOS-x86_64.iso
      - run:
          name: build (release)
          command: |
            make clean iso
            test -f build/x86_64/isofiles/boot/grub/grub.cfg
            test -f build/x86_64/isofiles/boot/initrd.tar
            test -f build/x86_64/dist/kernel-x86_64.bin
            test -f build/x86_64/dist/libc-willOS-x86_64.a
            test -f build/x86_64/dist/willOS-x86_64.iso
      - run:
          name: unit tests
          command: make clean test
      - run:
          name: fmt
          command: |
            make fmt
            git diff --exit-code || (echo "\n\nPlease run 'make fmt' to format the code and fix the problem(s) above"; false)
      - run:
          name: integration tests
          command: |
            export TERM=xterm
            make clean run-test
